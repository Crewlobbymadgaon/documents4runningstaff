<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    <title>Shed Order</title>
    <link rel="manifest" href="/documents4runningstaff/manifest.json" />
    <link rel="icon" href="/documents4runningstaff/favicon.ico" />
    <link rel="apple-touch-icon" href="/documents4runningstaff/icon-192.png" />
    <meta name="theme-color" content="#1f2937" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/shed_order_mao_2025.js" defer></script>
    <script defer src="main.js"></script>
    <script src="/documents4runningstaff/js/employee.js"></script>
    
    
    <style>
      .font-rajdhani {
        font-family: 'Rajdhani', sans-serif;
      }
      html,body {
  height: 100%;
  overscroll-behavior-y: none;
}

#pdfViewer iframe {
  display: block;
  width: 100%;
  height: 100%;
  border: none;
}

@media (max-width: 768px) {
  #docModal .bg-white {
    border-radius: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
  }
}
      @keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
  animation: fade-in 0.4s ease-out forwards;
}
      /* Force selected text inside <select> to center in all browsers */
.custom-select-center {
  text-align: center;         /* Applies in Chrome */
  text-align-last: center;    /* Applies in Firefox/Edge/Safari */
}

/* On iOS and some Android tablets, remove native appearance completely */
select.custom-select-center {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">

<header class="bg-gradient-to-r from-blue-900 via-blue-700 to-blue-900 text-white py-3 shadow-md">
  <div class="text-center px-4">
  
<h1 class="font-rajdhani text-xl sm:text-3xl md:text-4xl leading-tight font-extrabold">
      Digital Library
      <span class="text-yellow-300">for</span>
      Running Staff
</h1>
  <!-- Subheading -->
  <h2 class="font-rajdhani text-4xl sm:text-4xl md:text-5xl font-extrabold mt-2">
    Shed Order
  </h2>
      <h3 class="font-rajdhani text-2xl sm:text-2xl md:text-3xl font-extrabold mt-2">Madgaon Lobby
      </h3>
    </div>

<!-- Year Selector (center) and Hamburger (right) on same line -->
<div class="flex items-center justify-between mt-6">
  
  <!-- Invisible spacer to balance hamburger button -->
  <div class="w-12"></div>

<!-- Centered Year Selector with padding compensation -->
<div class="relative inline-block w-40">
 <select id="yearSelect" onchange="highlightSelectedYear()"
    class="appearance-none w-full bg-gradient-to-b from-blue-900 via-blue-500 to-blue-900
           text-white text-xl font-bold 
           px-0 py-2 rounded-md border border-blue-950 
           focus:bg-blue-950 focus:outline-none focus:ring-1 focus:ring-blue-950 shadow 
           text-center custom-select-center">
    <option class="bg-white text-blue-900 hover:bg-blue-100 transition duration-150 ease-in-out" value="2024">&nbsp;&nbsp;&nbsp;&nbsp;2024&nbsp;&nbsp;&nbsp;&nbsp;</option>
    <option class="bg-white text-blue-900 hover:bg-blue-100 transition duration-150 ease-in-out" value="2025">&nbsp;&nbsp;&nbsp;&nbsp;2025&nbsp;&nbsp;&nbsp;&nbsp;</option>
  </select>
 
<!-- Dropdown arrow -->
<div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-white text-sm">
  ▼
</div>
</div>
  <!-- Hamburger + Dropdown: wrapped in a relative container -->
<div class="relative">
  <!-- Hamburger Button (right) -->
  <button id="hamburgerBtn"
    class="bg-gradient-to-b from-blue-900 via-blue-500 to-blue-900 
           hover:from-blue-800 hover:to-blue-950 
           text-white p-2 rounded-md 
           border border-blue-950 
           shadow-lg 
           focus:outline-none focus:ring-2 focus:ring-blue-900 
           transition duration-150 ease-in-out"
    aria-label="Toggle Menu" aria-expanded="false">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
      viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  <!-- Dropdown menu (now correctly aligned below hamburger) -->
  <div id="dropdownMenu"
    class="hidden absolute right-0 mt-2 bg-white border border-blue-800 shadow-lg z-50 rounded-md w-52">
    <a href="index.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Home</a>
    <a href="so_lobby_selector.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Shed Order</a>
    <a href="safetycircular.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Safety Circular</a>
    <a href="counselling.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Counselling Topics</a>
    <a href="othercirculars.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Other Circulars</a>
    <a href="gnsr.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">G&SR</a>
    <a href="accidentmanual.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Accident Manual</a>
    <a href="wtt.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">WTT</a>
    <a href="readingmaterials.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">Reading Materials</a>
    <a href="tsd.html" class="block px-4 py-2 text-blue-900 hover:bg-blue-100">TSD</a>
  </div>
</div>
</div> <!-- Ends the flex row: justify-between -->
</header>
<section class="px-4 mt-8">
  <div id="shedOrderList" class="grid gap-4 max-w-2xl mx-auto"></div>
</section>

<!-- Modal -->
<div id="docModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden">
  <div class="w-full h-full flex flex-col items-center justify-center">
    <div class="bg-white w-[95vw] h-[90vh] max-h-[90vh] rounded-lg shadow-xl relative overflow-hidden flex flex-col">
     <!-- Only show on medium screens and above -->
  <div class="hidden md:flex justify-between items-center px-4 py-2 bg-blue-700 text-white text-lg font-semibold">
  <span id="documentTitle">Document Viewer</span>
  <div class="flex items-center space-x-2">
    <button
      onclick="openLoginModal(currentDocId)"
      class="bg-green-600 px-3 py-1 rounded text-sm hover:bg-green-700"
    >
      Acknowledge
    </button>
    <button
      onclick="closeModal()"
      class="text-white text-2xl font-bold"
    >&times;</button>
  </div>
</div>
 
      <div id="pdfViewer" class="flex-grow w-full overflow-auto relative bg-white">
        <!-- Iframe inserted here -->
      </div>
    </div>
  </div>
</div>


    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden">
  <div class="bg-white p-6 rounded-xl shadow max-w-sm w-full mx-auto mt-24 relative">
    <h2 class="text-xl font-bold mb-4 text-center text-blue-800">Employee Login</h2>
    <input type="text" id="empNumber" placeholder="Employee Number" class="w-full mb-3 px-3 py-2 border rounded" />
    <input type="password" id="empPassword" placeholder="Password" class="w-full mb-4 px-3 py-2 border rounded" />
    <div class="flex justify-between items-center">
      <button onclick="submitLogin()" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">
        Login
      </button>
      <button onclick="closeLoginModal()" class="text-red-600 font-bold">Cancel</button>
    </div>
  </div>
    </div>

    <!-- Declaration Modal -->
<div id="acknowledgeModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden">
  <div class="bg-white p-4 rounded-md shadow-lg w-[90%] max-w-md mx-auto mt-40">
    <h2 class="text-lg font-bold mb-2">Acknowledgement Declaration</h2>
    <p class="mb-2">I have read and understood the contents of the document.</p>
    
    <label class="flex items-center space-x-2 mb-4">
      <input type="checkbox" id="declarationCheck" class="accent-green-600">
      <span>I agree</span>
    </label>

    <textarea id="ackRemarks" class="w-full border border-gray-300 p-2 mb-4" rows="3" placeholder="Remarks or doubts (optional)"></textarea>

    <div class="flex justify-end space-x-2">
      <button onclick="submitAcknowledgement()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded">Submit</button>
      <button onclick="closeAcknowledgeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-1 rounded">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Toggle Dropdown
const hamburgerBtn = document.getElementById("hamburgerBtn");
const dropdownMenu = document.getElementById("dropdownMenu");

hamburgerBtn.addEventListener("click", (e) => {
  e.stopPropagation(); // Prevent click from bubbling to document
  dropdownMenu.classList.toggle("hidden");

  const isHidden = dropdownMenu.classList.contains("hidden");
  hamburgerBtn.setAttribute("aria-expanded", !isHidden);
});

// Close dropdown when a link inside it is clicked
dropdownMenu.querySelectorAll("a").forEach(link => {
  link.addEventListener("click", () => {
    dropdownMenu.classList.add("hidden");
    hamburgerBtn.setAttribute("aria-expanded", "false");
  });
});

// Close dropdown if clicking outside
document.addEventListener("click", (e) => {
  if (
    !dropdownMenu.classList.contains("hidden") &&
    !dropdownMenu.contains(e.target) &&
    !hamburgerBtn.contains(e.target)
  ) {
    dropdownMenu.classList.add("hidden");
    hamburgerBtn.setAttribute("aria-expanded", "false");
  }
});
    document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !dropdownMenu.classList.contains("hidden")) {
    dropdownMenu.classList.add("hidden");
    hamburgerBtn.setAttribute("aria-expanded", "false");
  }
});
  function loadShedOrders(year) {
    const existingScript = document.getElementById("shed-script");
    if (existingScript) existingScript.remove();

    const script = document.createElement("script");
    script.id = "shed-script";
    script.src = `js/shed_order_mao_${year}.js`;

    script.onload = () => {
      if (
        window.shedOrdersByYear &&
        Array.isArray(window.shedOrdersByYear[year]) &&
        window.shedOrdersByYear[year].length > 0
      ) {
        renderShedOrders(year);
      } else {
        showNoDataMessage();
      }
    };

    script.onerror = showNoDataMessage;

    document.body.appendChild(script);
  }

  function showNoDataMessage() {
    const container = document.getElementById("shedOrderList");
    container.innerHTML = `<div class="text-center text-red-600 font-semibold p-4">Data not available</div>`;
  }

  function highlightSelectedYear() {
    const year = document.getElementById("yearSelect").value;
    loadShedOrders(year);
  }

  window.addEventListener("DOMContentLoaded", () => {
  const yearSelect = document.getElementById("yearSelect");
  const currentYear = new Date().getFullYear();
  const optionExists = [...yearSelect.options].some(opt => opt.value === String(currentYear));
  yearSelect.value = optionExists ? currentYear : yearSelect.options[0].value;
  highlightSelectedYear();

  // Load 2025 orders only if not already handled
  if (window.shedOrdersByYear?.["2025"]) {
    renderShedOrders("2025");
  } else {
    setTimeout(() => renderShedOrders("2025"), 500);
  }
});

function renderShedOrders(year) {
  const orders = window.shedOrdersByYear[year];
  const shedOrderList = document.getElementById("shedOrderList");
  shedOrderList.innerHTML = "";

  if (!orders || orders.length === 0) {
    shedOrderList.innerHTML = "<p class='text-center text-gray-500'>No shed orders available.</p>";
    return;
  }

  const reversedOrders = [...orders].reverse();
  const ackStatus = JSON.parse(localStorage.getItem("acknowledgedDocs") || "[]");

  reversedOrders.forEach(order => {
    const filePath = `/documents4runningstaff/doc_shed_order_mao_${year}/${order.file}`;
    const card = document.createElement("div");
    card.className = `bg-white relative rounded-xl p-4 border-2 border-blue-300 shadow-md transition duration-300 text-gray-800 text-base leading-relaxed break-words`;

    card.innerHTML = `
      <div class="font-bold text-lg text-blue-900 mb-2">${order.number}</div>
      <div class="text-gray-700 mb-4">${order.topic}</div>
      <div class="flex justify-between items-center px-4 sm:px-6 md:px-8 py-2 sm:py-3">
        <button onclick="openModal('${filePath}', '${order.number}', '${order.topic.replace(/'/g, "\\'")}')" title="View Document"
          class="flex items-center gap-2 text-xs sm:text-sm font-bold text-white bg-gradient-to-b from-blue-900 via-blue-500 to-blue-900 hover:scale-105 transform transition duration-200 px-3 py-1.5 sm:px-4 sm:py-2 rounded-md border border-blue-950 shadow-lg focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-4 h-4 sm:w-5 sm:h-5">
            <path d="M12 5c-7 0-9 7-9 7s2 7 9 7 9-7 9-7-2-7-9-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
          </svg>
          <span>View</span>
        </button>
        <a href="${filePath}" download title="Download Document"
           class="flex items-center gap-2 text-xs sm:text-sm font-bold text-white bg-gradient-to-b from-blue-900 via-blue-500 to-blue-900 hover:scale-105 transform transition duration-200 px-3 py-1.5 sm:px-4 sm:py-2 rounded-md border border-blue-950 shadow-lg focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-4 h-4 sm:w-5 sm:h-5">
            <path d="M12 16.5l4.5-4.5h-3V3h-3v9h-3l4.5 4.5zm-9 3h18v-2H3v2z"/>
          </svg>
          <span>Download</span>
        </a>
      </div>
      <div id="ack-${order.number}" class="text-green-600 text-sm font-semibold mt-2">
        ${ackStatus.includes(order.number) ? "✔️ Acknowledged" : ""}
      </div>
    `;

    shedOrderList.appendChild(card);
  });
}

let currentDocId = ""; // Global variable at top of your script
let pendingAcknowledge = false;
  function openModal(filePath, orderTitle, orderTopic) {
 currentDocId = orderTitle; // Make sure this is set!
  const modal = document.getElementById("docModal");
  const container = document.getElementById("pdfViewer");
  const titleElement = document.getElementById("documentTitle");
  container.innerHTML = '';
  modal.classList.remove("hidden");
  document.body.style.overflow = "hidden";
  history.pushState({ modalOpen: true }, "", "#doc");

  if (titleElement) {
    titleElement.textContent = orderTitle || "Document Viewer";
  }

  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    const fallback = document.createElement("div");
    fallback.className = `
      w-full h-full flex flex-col justify-between items-center
      text-center px-4 py-8 bg-gradient-to-b from-gray-100 to-white
      animate-fade-in
    `;

    fallback.innerHTML = `
      <div class="text-center w-full animate-fade-in px-4 py-6">
        <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 rounded-2xl shadow-lg p-6 max-w-md mx-auto border border-blue-300">
          <div class="text-blue-800 text-3xl mb-2">📄</div>
          <h2 class="text-xl font-bold text-gray-800 mb-2">${orderTitle}</h2>
          <p class="text-base sm:text-lg text-gray-700 mb-6">${orderTopic}</p>


          <a href="${filePath}" target="_blank"
            class="inline-block w-full bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg shadow hover:bg-blue-700 transition">
            🚀 Open Document
          </a>

          <div class="mt-6 flex justify-between gap-4">
            <button onclick="acknowledgeDocument()"
              class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition text-sm font-medium">
              ✅ Acknowledge
            </button>
            <button onclick="closeModal()"
              class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition text-sm font-medium">
              ❌ Close
            </button>
          </div>
        </div>
      </div>
    `;

    container.appendChild(fallback);
    return;
  }

  // Desktop iframe view
  const iframe = document.createElement("iframe");
  iframe.src = filePath;
  iframe.className = "w-full h-full border-0";
  iframe.allow = "autoplay";
  container.appendChild(iframe);
}


function closeModal() {
  const modal = document.getElementById("docModal");
  const container = document.getElementById("pdfViewer");
  modal.classList.add("hidden");
  container.innerHTML = '';
  document.body.style.overflow = "";

  // Reset zoom by removing any zoom-related transformations (if added)
  document.body.style.transform = "none";

  if (location.hash === "#doc") {
    history.back();
  }
}


if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log("Service Worker registered:", reg))
      .catch(err => console.log("Service Worker registration failed:", err));
  });
}


  document.addEventListener("keydown", (e) => {
  // Close dropdown if open
  if (e.key === "Escape" && !dropdownMenu.classList.contains("hidden")) {
    dropdownMenu.classList.add("hidden");
    hamburgerBtn.setAttribute("aria-expanded", "false");
  }

  // Close document modal if open
  const modal = document.getElementById("docModal");
  if (e.key === "Escape" && !modal.classList.contains("hidden")) {
    closeModal();
  }
});
function acknowledgeDocument() {
  // Trigger login first
  pendingAcknowledge = true;
  openLoginModal();
}
  function openLoginModal() {
  document.getElementById("loginModal").classList.remove("hidden");
}

function closeLoginModal() {
  document.getElementById("loginModal").classList.add("hidden");
  document.getElementById("empNumber").value = "";
  document.getElementById("empPassword").value = "";
  pendingAcknowledge = false;
}

function submitLogin() {
  const empNo = document.getElementById("empNumber").value.trim();
  const password = document.getElementById("empPassword").value;

  const matchedEmployee = employees.find(emp => emp.empNo === empNo && emp.password === password);

  if (matchedEmployee) {
    alert(`Welcome ${matchedEmployee.name} (${matchedEmployee.designation})`);

    localStorage.setItem("loggedInEmployee", JSON.stringify(matchedEmployee));

    // Instead of acknowledging directly, show declaration + remarks form
    closeLoginModal();
    showAcknowledgeForm(matchedEmployee);
  } else {
    alert("Invalid employee number or password.");
  }
}

  // Save login session (optional)
  localStorage.setItem("loggedInEmployee", JSON.stringify(matchedEmployee));

  // Close login modal
  closeLoginModal();

  // Acknowledge document if pending
  if (pendingAcknowledge && currentDocId) {
    const now = new Date().toLocaleString();

    // Save acknowledgment data
    const ackRecord = {
      docId: currentDocId,
      empNo: matchedEmployee.empNo,
      name: matchedEmployee.name,
      designation: matchedEmployee.designation,
      dateTime: now,
      remarks: "" // Optional: ask for remarks later
    };

    const ackList = JSON.parse(localStorage.getItem("acknowledgements") || "[]");
    ackList.push(ackRecord);
    localStorage.setItem("acknowledgements", JSON.stringify(ackList));

    // Update card view (only show "Acknowledged")
    const ackDiv = document.getElementById(`ack-${currentDocId}`);
    if (ackDiv) {
      ackDiv.textContent = "✔️ Acknowledged";
    }

    // Close document viewer
    closeModal();

    // Show welcome
    alert(`Welcome ${matchedEmployee.name} (${matchedEmployee.designation})`);
  }
}

  function showAcknowledgeForm(employee) {
  window.loggedInEmployee = employee; // Store globally for next use
  document.getElementById("acknowledgeModal").classList.remove("hidden");
}

function closeAcknowledgeModal() {
  document.getElementById("acknowledgeModal").classList.add("hidden");
}

  function submitAcknowledgement() {
  const declaration = document.getElementById("declarationCheck").checked;
  const remarks = document.getElementById("ackRemarks").value.trim();

  if (!declaration) {
    alert("You must agree to the declaration before submitting.");
    return;
  }

  const docId = window.currentDocId;
  const employee = window.loggedInEmployee;

  if (!docId || !employee) {
    alert("Missing document or employee info.");
    return;
  }

  const now = new Date().toLocaleString();

  // Update UI
  const ackDiv = document.getElementById(`ack-${docId}`);
  if (ackDiv) {
    ackDiv.textContent = `✔️ Acknowledged by ${employee.name} (${employee.designation}) on ${now}`;
  }

  // Save to Firebase (assumes Firebase already initialized)
  const data = {
    empNo: employee.empNo,
    name: employee.name,
    designation: employee.designation,
    docId: docId,
    timestamp: now,
    remarks: remarks
  };

  firebase.database().ref(`acknowledgements/${docId}/${employee.empNo}`).set(data)
    .then(() => {
      console.log("Acknowledgement saved to Firebase.");
    })
    .catch(error => {
      console.error("Firebase save error:", error);
    });

  // Optional: Save locally
  const key = "acknowledgedDocs";
  const acknowledged = JSON.parse(localStorage.getItem(key)) || [];
  if (!acknowledged.includes(docId)) {
    acknowledged.push(docId);
    localStorage.setItem(key, JSON.stringify(acknowledged));
  }

  // Close modals
  closeAcknowledgeModal();
  closeModal();
  }

  
  


</script>
    



</body>
</html>
